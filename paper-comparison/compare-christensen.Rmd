---
title: "Comparison with Christensen paper"
author: "Renata Diaz"
date: "12/13/2018"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Side-by-side comparison of LDATS results (and Portal rodents vignette) with analysis from Christensen et al 2018. 

## LDATS Installation

To obtain the most recent version of **LDATS**, install the most recent 
version from GitHub:

```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("weecology/LDATS")
```

```{r, eval = T}
library(LDATS)
```

## Christensen 2018 analysis files

Download Christensen 2018 analysis scripts & data files from [Extreme-events-LDA repo:](https://github.com/emchristensen/Extreme-events-LDA)

Main Analysis Scripts:

  * rodent_LDA_analysis.R main script for analyzing rodent community change using LDA
  
  * rodent_data_for_LDA.R contains a function that creates the rodent data table used in analyses
  
  * AIC_model_selection.R contains functions for calculating AIC for different candidate LDA models
  
  * changepointmodel.r contains change-point model code
  
  * LDA-distance.R function for computing Hellinger distance analyses
    
Data:

  * Rodent_table_dat.csv table of rodent data, created by rodent_data_for_LDA.R

Figure scripts:

  * LDA_figure_scripts.R contains functions for making main plots in manuscript (Fig 1). Called from rodent_LDA_analysis.R


```{r download Christensen, eval = FALSE}

files_to_download <- c('rodent_LDA_analysis.r', 'rodent_data_for_LDA.r', 'AIC_model_selection.R', 'changepointmodel.r', 'LDA-distance.R', 'Rodent_table_dat.csv', 'LDA_figure_scripts.R')

for(i in 1:length(files_to_download)) {
  download.file(url = paste0("https://raw.githubusercontent.com/emchristensen/Extreme-events-LDA/master/", files_to_download[i]),
                destfile = paste0('christensen-ecology-files/', files_to_download[i]))
}

rm(files_to_download)
rm(i)

```


## Data

The Portal rodents control data is included in the LDATS package:

```{r LDATS data}

data(rodents)

ldats_dat <- rodents[[1]]
ldats_dates <- rodents[[2]]
head(ldats_dat)

```

Load the data used in Christensen et al: 

```{r Ch data}
source('christensen-ecology-files/rodent_data_for_LDA.r')
dat = create_rodent_table(period_first = 1,
                          period_last = 436,
                          selected_plots = c(2,4,8,11,12,14,17,22),
                          selected_species = c('BA','DM','DO','DS','NA','OL','OT','PB','PE','PF','PH','PI','PL','PM','PP','RF','RM','RO','SF','SH','SO'), diagnose = F)

# dates to go with count data
moondat = read.csv(text=getURL("https://raw.githubusercontent.com/weecology/PortalData/master/Rodents/moon_dates.csv"),stringsAsFactors = F)
moondat$date = as.Date(moondat$censusdate)

period_dates = filter(moondat,period %in% rownames(dat)) %>% select(period,date)
dates = period_dates$date

ch_dat <- dat

ch_dates <- dates

rm(list = c('dat', 'dates', 'period_dates', 'moondat',
            'create_rodent_table'))

```


Compare paper data to LDATS data:

```{r rodent data comparison, eval = F} 

compare <- ldats_dat == ch_dat

compare_rows <- vector(length = nrow(compare)) 

for(i in 1:nrow(compare)) {
  if(sum(compare[i, ]) == 21) {
    compare_rows[i] <- TRUE
  } else {
    compare_rows[i] <- FALSE
  }
}

length(which(compare_rows == F))
ldats_dat[ which(compare_rows == F), ]
ch_dat[ which(compare_rows == F), ]
```


There are 16 rows where the data included in LDATS differs from the paper data. This looks like it is because the LDATS data is not adjusted to account for trapping effort, but the paper data has divided all census counts by the actual number of plots trapped and multiplied by 8 to account for incompletely-trapped censuses. 

Double-check:

```{r Ch rodent adjustment, eval = F}

source('christensen-ecology-files/rodent_data_for_LDA.r')
diagnose_dat = create_rodent_table(period_first = 1,
                          period_last = 436,
                          selected_plots = c(2,4,8,11,12,14,17,22),
                          selected_species = c('BA','DM','DO','DS','NA','OL','OT','PB','PE','PF','PH','PI','PL','PM','PP','RF','RM','RO','SF','SH','SO'), diagnose = T)

adjusted_table <- diagnose_dat[[1]]
raw_table <- diagnose_dat[[2]]
nplots <- diagnose_dat[[3]]
nplots <- nplots[ which(nplots$period <= 436), ]

compare_raw <- raw_table == ldats_dat
length(which(compare_raw == F))

which(compare_rows == F) 
which(nplots$x < 8)

```

I added an argument 'diagnose' to the create_rodent_table() function. If T, returns the raw table & # of plots tables as well as the adjusted table. 

The lines that are different are the lines that were adjusted; if you don't adjust the paper data you get the same table as the LDATS data. 

```{r data adjustment cleanup, eval = F, include = FALSE}
rm(list = c('diagnose_dat', 'nplots', 'compare', 'compare_raw', 'adjusted_table', 'i', 'compare_rows', 'raw_table', 'create_rodent_table'))
```


For now I will use the *adjusted rodent table* because this will avoid artificially low abundances for incompletely trapped periods.

```{r switch to adjusted rodent data}

ldats_dat <- as.matrix(ch_dat)
ldats_dat <- apply(ldats_dat, c(1,2), FUN = as.integer)
rodents$document_term_table <- ldats_dat
rm(ldats_dat)
rm(ldats_dates)
rm(ch_dat)
```

## LDA

While LDATS can run start-to-finish with `LDATS::LDA_TS`, I'm first going to step through function-by-function to isolate differences with the paper. 

```{r LDATS LDAs, eval = F}

ldats_ldas <- LDATS::LDA_set(document_term_table = rodents$document_term_table, topics = c(2:6), nseeds = 100)
ldats_lda_selected <- LDATS::select_LDA(LDA_models = ldats_ldas)

```


Paper LDAS:

```{r paper LDAs, eval = F}
source('christensen-ecology-files/AIC_model_selection.R')
source('christensen-ecology-files/LDA-distance.R')

# Fit a bunch of LDA models with different seeds
# Only use even numbers for seeds because consecutive seeds give identical results
seeds = 2*seq(200)

# repeat LDA model fit and AIC calculation with a bunch of different seeds to test robustness of the analysis
best_ntopic = repeat_VEM(rodents[[1]],
                         seeds,
                         topic_min=2,
                         topic_max=6)
hist(best_ntopic$k,breaks=c(0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5),xlab='best # of topics', main='')

# 2b. how different is species composition of 4 community-types when LDA is run with different seeds?
# ==================================================================
# get the best 100 seeds where 4 topics was the best LDA model
seeds_4topics = best_ntopic %>% 
  filter(k == 4) %>% 
  arrange(aic) %>% 
  head(100) %>% 
  pull(SEED)

# choose seed with highest log likelihood for all following analyses
#    (also produces plot of community composition for 'best' run compared to 'worst')
best_seed = calculate_LDA_distance(rodents[[1]],seeds_4topics)
mean_dist = unlist(best_seed)[2]
max_dist = unlist(best_seed)[3]

# ==================================================================
# 3. run LDA model
# ==================================================================
ntopics = 4
SEED = unlist(best_seed)[1]  # For the paper, I use seed 206
ldamodel = LDA(rodents[[1]],ntopics, control = list(seed = SEED),method='VEM')


```


```{r save LDAs, eval = F, include = F}
save(ldamodel, file = 'model-stash/paper_lda.Rds')
save(ldats_lda_selected, file = 'model-stash/ldats_lda.Rds')
```

```{r reload LDAS, include = FALSE}

load('model-stash/ldats_lda.Rds')
load('model-stash/paper_lda.Rds')

```

### Plot LDAS

```{r plot LDAs}
# Paper
plot(ldamodel, cols = NULL, option = "D")

# LDATS
plot(ldats_lda_selected[[1]], cols = NULL, option = "D")
```

## Changepoint models

I am going to compare four combinations of LDA + changepoint models:

* LDATS LDA + LDATS changepoint
* LDATS LDA + paper changepoint
* Paper LDA + LDATS changepoint
* Paper LDA + paper changepoint

There is the additional wrinkle of `document_term_weights`. The paper weighted all sample periods equally, wheras LDATS can weight sample periods according to how many individuals were captured. We now believe it is more appropriate to weight periods proportional to captures. However, for the purposes of comparison, I will continue to set all weights = 1 for both changepoint models. For an example of LDATS run with proportional weights, see the rodents vignette. [?]

#### run LDATS LDA with LDATS changepoint
```{r, include = F}
# remove paper LDA (for memory)
rm(ldamodel)
```

```{r LDATS LDA + LDATS cpt, eval = F}
# Run changepoint

ldats_ldats <- LDATS::TS_on_LDA(LDA_models = ldats_lda_selected,
                                document_covariate_table = rodents[[2]],
                                formulas =c(~ sin_year + cos_year),
                                nchangepoints = c(2, 3),
                                weights = NULL)

save(ldats_ldats, file = 'model-stash/ldats_ldats.Rds')

# Select best changepoint

ldats_ldats_selected <- LDATS::select_TS(TS_models = ldats_ldats)

save(ldats_ldats_selected, file = '/Users/renatadiaz/Documents/model-stash/ldats_ldats_selected.Rds')

```

```{r, eval = F}
rm(ldats_ldats)
rm(ldats_ldats_selected)
```

#### run LDATS LDA with paper changepoint

```{r ldats paper, eval = F}
source('christensen-ecology-files/changepointmodel.r')
# set up parameters for model
year_continuous = 1970 + as.integer(julian(ch_dates)) / 365.25
x = data.frame(
  year_continuous = year_continuous,
  sin_year = sin(year_continuous * 2 * pi),
  cos_year = cos(year_continuous * 2 * pi)
)

# run models with 1, 2, 3, 4, 5 changepoints
cp_results_rodent = changepoint_model(ldats_lda_selected[[1]], x, 1, weights = rep(1,length(year_continuous)))

save(cp_results_rodent, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda1.Rds')
rm(cp_results_rodent)


cp_results_rodent2 = changepoint_model(ldats_lda_selected[[1]], x, 2, weights = rep(1,length(year_continuous)))


save(cp_results_rodent2, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda2.Rds')
rm(cp_results_rodent2)


cp_results_rodent3 = changepoint_model(ldats_lda_selected[[1]], x, 3, weights = rep(1,length(year_continuous)))
save(cp_results_rodent3, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda3.Rds')
rm(cp_results_rodent3)

cp_results_rodent4 = changepoint_model(ldats_lda_selected[[1]], x, 4, weights = rep(1,length(year_continuous)))
save(cp_results_rodent4, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda4.Rds')
rm(cp_results_rodent4)

cp_results_rodent5 = changepoint_model(ldats_lda_selected[[1]], x, 5, weights = rep(1,length(year_continuous)))
save(cp_results_rodent5, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda5.Rds')
rm(cp_results_rodent5)

cp_results_rodent6 = changepoint_model(ldats_lda_selected[[1]], x, 6, weights = rep(1,length(year_continuous)))
save(cp_results_rodent6, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_ldats_lda6.Rds')
rm(cp_results_rodent6)

rm(ldats_lda_selected)
```

#### run paper LDA with paper changepoint
```{r paper paper, eval = F}
source('christensen-ecology-files/changepointmodel.r')
# set up parameters for model
year_continuous = 1970 + as.integer(julian(ch_dates)) / 365.25
x = data.frame(
year_continuous = year_continuous,
sin_year = sin(year_continuous * 2 * pi),
cos_year = cos(year_continuous * 2 * pi)
)
# run models with 1, 2, 3, 4, 5 changepoints
cp_results_rodent = changepoint_model(ldamodel, x, 1, weights = rep(1,length(year_continuous)))
save(cp_results_rodent, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda1.Rds')
rm(cp_results_rodent)


cp_results_rodent2 = changepoint_model(ldamodel, x, 2, weights = rep(1,length(year_continuous)))
save(cp_results_rodent2, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda2.Rds')
rm(cp_results_rodent2)

cp_results_rodent3 = changepoint_model(ldamodel, x, 3, weights = rep(1,length(year_continuous)))
save(cp_results_rodent3, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda3.Rds')
rm(cp_results_rodent3)

cp_results_rodent4 = changepoint_model(ldamodel, x, 4, weights = rep(1,length(year_continuous)))
save(cp_results_rodent4, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda4.Rds')
rm(cp_results_rodent4)

cp_results_rodent5 = changepoint_model(ldamodel, x, 5, weights = rep(1,length(year_continuous)))
save(cp_results_rodent5, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda5.Rds')
rm(cp_results_rodent5)

cp_results_rodent6 = changepoint_model(ldamodel, x, 6, weights = rep(1,length(year_continuous)))
save(cp_results_rodent6, file = '/Users/renatadiaz/Documents/model-stash/paper_cpt_paper_lda6.Rds')
rm(cp_results_rodent6)
```

#### run paper LDA with LDATS changepoint
```{r paper ldats, eval = F}
# Run changepoint

paper_ldats <- LDATS::TS_on_LDA(LDA_models = ldamodel,
                                document_covariate_table = rodents[[2]],
                                formulas =c(~ sin_year + cos_year),
                                nchangepoints = c(2, 3, 4, 5, 6),
                                weights = NULL)

save(paper_ldats, file = 'model-stash/paper_ldats.Rds')

# Select best changepoint

paper_ldats_selected <- LDATS::select_TS(TS_models = paper_ldats)

save(paper_ldats_selected, file = '/Users/renatadiaz/Documents/model-stash/paper_ldats_selected.Rds')

```


