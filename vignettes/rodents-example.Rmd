---
title: "LDATS Rodents Example"
author: "Juniper L. Simonis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{rodentsexample}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
library(LDATS)
vers <- packageVersion("LDATS")
today <- Sys.Date()
```

This vignette walks through an example of **LDATS** at the command line and
was constructed using **LDATS** version `r vers` on `r today`.


## Installation

To obtain the most recent version of **LDATS**, install the most recent 
version from GitHub:

```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("weecology/LDATS")
```

## Data

For this vignette, we will be using rodent data from the control plots of the
[Portal Project](https://github.com/weecology/portaldata), which come with
the **LDATS** package.

`rodents` contains two data tables, a `document_term_table` and a `document_covariate_table`. 

The `document_term_table` is a matrix of species (term) counts by sampling period. Importantly, the `document_term_table` contains raw counts of individual rodent captures, not catch per unit effort. The LDA models operate on proportions and weight the information from each sampling period according to total catch (document size). Similarly, the TS models use the LDA compositional breakdown and weight the information from each period according to the total catch. We therefore give both models un-adjusted data. The values in the `document_term_table` must be integers.

The `document_covariate_table` contains the covariates we would like to use for the time series models. In this case, we have a column for `newmoon`, which is the time step for each of our sampling periods. This column can include nonconsecutive time steps (i.e., `2, 4, 5`) if sampling periods are skipped or at unequal intervals. If there is no time column, `LDATS` will assume all time steps are equidistant. We also include columns `sin_year` and `cos_year` so we can account for seasonal dynamics.

```{r}
data(rodents)
head(rodents$document_term_table, 10)
head(rodents$document_covariate_table, 10)
```


## Stage 1: LDA models

We use `LDA_set` and `select_LDA` to run LDA models with varying numbers of topics (`2:6`) and many seeds and select the best model.

We use `LDA_controls_list())` to pass controls to the LDA function. In this case, we can set `quiet = TRUE` to make the model run quietly. 

```{r lda_set, eval =F}
lda_model_set <- LDA_set(document_term_table = rodents$document_term_table,
                         topics = c(2:6),
                         nseeds = 100,
                        control = LDA_controls_list(quiet = TRUE))

```


If we do not pass any controls, by default, `quiet = FALSE` (here run with only `2:3` topics and  `10` seeds, to keep output short): 

```{r lda set not quiet}
lda_model_set2 <- LDA_set(document_term_table = rodents$document_term_table,
                         topics = c(2:3),
                         nseeds = 10)
```

`LDA_set()` returns a list of LDA models. We use `select_LDA()` to identify the best number of topics and choice of seed from our set of models. By default, we will choose models based on minimum AIC. To use different selection criteria, define the appropriate functions and specify them using `LDA_controls_list(measurer = [measurer function], selector = [max, min, etc])`. 

```{r load lda model set, include = F}
load(here::here('vignettes', 'rodents-example-files', 'lda_model_set.Rds'))
rm(lda_model_set2)
```

```{r select LDA}
selected_lda_model <- select_LDA(lda_model_set)
```


We can access the results of the model:

```{r LDA results}
# Number of topics:

selected_lda_model[[1]]@k

# Topic composition of communities at each time step
# Columns are topics; rows are time steps
head(selected_lda_model[[1]]@gamma)

```

`LDATS` includes flexible plot functionality for LDAs and time series. The top panel illustrates topic composition by species, and the bottom panel shows the proportion of the community made up of each topic over time. For all the available plot options see `?plot.LDA_VEM`. 

```{r plot lda, fig.width=6, fig.height=6}
plot(selected_lda_model[[1]])

```


## Stage 2: TS changepoint models

TS_on_LDA

select_TS

Illustrate TS_controls_list

Illustrate plotting

Illustrate result pulling
